{% extends "base.html" %}

{% block title %}Detalles del Caso{% endblock %}

{% block content %}
<div style="padding: 2rem; max-width: 800px; margin: 0 auto;">

    <div style="margin-bottom: 2rem;">
        {% if user.role.value == 'school_admin' %}
        <a href="/dashboard/school_admin" style="color: #3498db; text-decoration: none;">&larr; Volver al Panel de
            Direcci√≥n</a>
        {% elif user.role.value == 'super_admin' %}
        <a href="javascript:history.back()" style="color: #3498db; text-decoration: none;">&larr; Volver</a>
        {% else %}
        <a href="/dashboard/teacher" style="color: #3498db; text-decoration: none;">&larr; Volver al Panel Docente</a>
        {% endif %}
    </div>

    <header
        style="position: relative; background: white; padding: 2rem; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); margin-bottom: 2rem; border-left: 5px solid {{ '#e74c3c' if survey.risk_level.value in ['high', 'critical'] else '#2ecc71' }};">
        <div style="display: flex; justify-content: space-between; align-items: start;">
            <div>
                <h1 style="margin: 0; color: #2c3e50;">Caso #{{ survey.id }}</h1>
                <p style="color: #7f8c8d; margin-top: 0.5rem;">Alumno: <strong>{{ survey.student.name if
                        survey.student.name else survey.student.internal_code }}</strong></p>
                <p style="color: #95a5a6; font-size: 0.9rem;">Fecha: {{ survey.date_submitted.strftime('%d/%m/%Y %H:%M')
                    }}</p>
            </div>
            <div style="text-align: right; display: flex; flex-direction: column; align-items: flex-end;">
                {% if user.role.value == 'super_admin' %}
                <div
                    style="position: absolute; top: 1rem; right: 1rem; display: flex; flex-direction: column; align-items: flex-end; gap: 0.5rem;">
                    <button onclick="openModal()"
                        style="padding: 0.5rem 1rem; background-color: #8e44ad; color: white; border: none; border-radius: 4px; cursor: pointer; display: inline-flex; align-items: center; gap: 0.5rem; font-size: 0.9rem;">
                        üì§ Derivar a Experto
                    </button>
                    <!-- Classification Checklist -->
                    <div
                        style="background: white; padding: 0.5rem; border: 1px solid #ddd; border-radius: 6px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); text-align: left; font-size: 0.9rem;">
                        <div style="margin-bottom: 0.2rem;">
                            <label
                                style="cursor: pointer; display: flex; align-items: center; gap: 0.5rem; color: #e74c3c;">
                                <input type="radio" name="case_classification" value="false_positive"> Falso Positivo
                            </label>
                        </div>
                        <div style="margin-bottom: 0.2rem;">
                            <label
                                style="cursor: pointer; display: flex; align-items: center; gap: 0.5rem; color: #f39c12;">
                                <input type="radio" name="case_classification" value="false_negative"> Falso Negativo
                            </label>
                        </div>
                        <div>
                            <label
                                style="cursor: pointer; display: flex; align-items: center; gap: 0.5rem; color: #27ae60;">
                                <input type="radio" name="case_classification" value="real_case"> Caso Real
                            </label>
                        </div>
                    </div>
                </div>
                {% endif %}
                <span
                    style="font-size: 1.5rem; font-weight: bold; color: {{ '#e74c3c' if survey.risk_level.value in ['high', 'critical'] else '#27ae60' }};">
                    Riesgo {{ survey.risk_level.value.upper() }}
                </span>
                <p style="margin: 0; color: #7f8c8d;">Score: {{ survey.calculated_risk_score }}/100</p>
            </div>
        </div>

        <div style="margin-top: 2rem; padding-top: 1rem; border-top: 1px solid #eee;">
            <h3 style="color: #2c3e50; font-size: 1.1rem; margin-bottom: 0.5rem;">An√°lisis de IA</h3>
            <p style="color: #34495e; line-height: 1.6;">{{ survey.ai_summary }}</p>
        </div>
    </header>

    <section style="background: white; padding: 2rem; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05);">
        <h2 style="color: #2c3e50; margin-bottom: 1.5rem; padding-bottom: 1rem; border-bottom: 2px solid #f0f2f5;">
            Respuestas del Cuestionario</h2>

        <div id="answers-container">
            <!-- Las respuestas se renderizar√°n v√≠a JS porque est√°n en JSON -->
            Cargando respuestas...
        </div>
    </section>

    <script id="survey-data" type="application/json">
        {{ survey.raw_answers | safe }}
    </script>

    <script>
        const rawAnswers = JSON.parse(document.getElementById('survey-data').textContent);
        const container = document.getElementById('answers-container');

        const labels = {
            "p_item_1": "1. Ropa rota / material da√±ado",
            "p_item_2": "2. Heridas o moratones",
            "p_item_3": "3. Insultos o motes",
            "p_item_4": "4. Exclusi√≥n social",
            "p_item_5": "5. Coacci√≥n o amenazas",
            "p_item_6": "6. Ansiedad al ir al colegio",
            "p_item_7": "7. Dolores de cabeza/est√≥mago",
            "p_item_8": "8. Cambios de sue√±o/alimentaci√≥n",
            "p_item_9": "9. Cambios de humor",
            "p_item_10": "10. Evitaci√≥n del tema escolar",
            "p_item_11": "11. Nerviosismo con m√≥vil/tablet",
            "p_item_12": "12. Ocultar pantalla",
            "p_item_13": "13. Ciberacoso evidencia",
            "p_observations": "Observaciones Familia"
        };

        let html = '<dl style="display: grid; grid-template-columns: 1fr; gap: 1rem;">';

        for (const [key, value] of Object.entries(rawAnswers)) {
            const label = labels[key] || key;
            html += `
                <div style="padding: 1rem; background: #f8f9fa; border-radius: 8px;">
                    <dt style="font-weight: 600; color: #7f8c8d; font-size: 0.9rem; margin-bottom: 0.5rem;">${label}</dt>
                    <dd style="margin: 0; color: #2c3e50; font-weight: 500;">${value}</dd>
                </div>
            `;
        }
        html += '</dl>';
        container.innerHTML = html;
    </script>
</div>
</div>

<!-- Modal Structure -->
<div id="deriveModal" data-survey-id="{{ survey.id }}"
    style="display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.5); backdrop-filter: blur(2px);">
    <div
        style="background-color: #fefefe; margin: 10% auto; padding: 2rem; border: 1px solid #888; width: 90%; max-width: 500px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.2);">
        <h2 style="margin-top: 0; color: #2c3e50; font-size: 1.5rem;">Derivar Caso a Experto</h2>
        <p style="color: #7f8c8d; line-height: 1.5;">Introduce el correo electr√≥nico del experto externo. Se le enviar√°
            un resumen completo de este caso, incluyendo el an√°lisis de IA.</p>

        <form id="deriveForm" style="margin-top: 1.5rem;">
            <label for="expertEmail"
                style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #34495e;">Email del
                Experto:</label>
            <input type="email" id="expertEmail" name="expertEmail" required placeholder="ejemplo@psicologia.com"
                style="width: 100%; padding: 0.8rem; margin-bottom: 1.5rem; border: 1px solid #bdc3c7; border-radius: 6px; box-sizing: border-box;">

            <div style="text-align: right; display: flex; gap: 1rem; justify-content: flex-end;">
                <button type="button" onclick="closeModal()"
                    style="padding: 0.8rem 1.2rem; background-color: #ecf0f1; color: #7f8c8d; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">Cancelar</button>
                <button type="submit" id="submitBtn"
                    style="padding: 0.8rem 1.2rem; background-color: #8e44ad; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">Enviar
                    Informaci√≥n</button>
            </div>
        </form>
    </div>
</div>

<script>
    // Modal Logic
    const modal = document.getElementById("deriveModal");
    const form = document.getElementById("deriveForm");
    const submitBtn = document.getElementById("submitBtn");

    function openModal() {
        modal.style.display = "block";
        document.getElementById("expertEmail").focus();
    }

    function closeModal() {
        modal.style.display = "none";
        form.reset();
    }

    // Close on outside click
    window.onclick = function (event) {
        if (event.target == modal) {
            closeModal();
        }
    }

    // Handle Form Submit
    form.addEventListener('submit', async (e) => {
        e.preventDefault();
        const email = document.getElementById("expertEmail").value;
        const surveyId = modal.getAttribute('data-survey-id');

        // Disable button
        submitBtn.disabled = true;
        submitBtn.innerText = "Enviando...";

        try {
            const response = await fetch(`/dashboard/case/${surveyId}/derive`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ email: email })
            });

            if (response.ok) {
                const data = await response.json();
                alert("‚úÖ √âxito: " + data.message);
                closeModal();
            } else {
                const err = await response.json();
                alert("‚ùå Error: " + (err.detail || "Error desconocido"));
            }
        } catch (error) {
            console.error(error);
            alert("‚ùå Error de conexi√≥n al servidor.");
        } finally {
            submitBtn.disabled = false;
            submitBtn.innerText = "Enviar Informaci√≥n";
        }
    });
</script>
{% endblock %}